# CSV Import Script for Airdrop Lottery

このスクリプトは、CSVファイルからアドレスを読み込んで、Airdrop Lotteryスマートコントラクトの`add_participant`関数を1000件ずつバッチ処理で実行します。

## 特徴

- **バッチ処理**: 1000件ずつ処理してガス制限を回避
- **エラーハンドリング**: 失敗したバッチの詳細ログ
- **進捗表示**: 処理状況をリアルタイムで表示
- **Dry Run モード**: 実際の実行前にテスト可能
- **アドレス検証**: 無効なアドレス形式を自動検出・スキップ

## 必要な環境

- Python 3.6+
- Aptos CLI がインストール済み
- 適切なAptos アカウント設定

## 使用方法

### 基本的な使用方法

```bash
python csv_import_script.py \
  --csv participants.csv \
  --lottery-id 1 \
  --contract-address 0x123...
```

### オプション付きの使用方法

```bash
python csv_import_script.py \
  --csv participants.csv \
  --lottery-id 1 \
  --contract-address 0x123... \
  --address-column wallet_address \
  --batch-size 500 \
  --delay 3.0 \
  --verbose
```

### Dry Run（テスト実行）

```bash
python csv_import_script.py \
  --csv participants.csv \
  --lottery-id 1 \
  --contract-address 0x123... \
  --dry-run
```

## パラメータ

| パラメータ | 必須 | デフォルト | 説明 |
|-----------|------|-----------|------|
| `--csv` | ✅ | - | CSVファイルのパス |
| `--lottery-id` | ✅ | - | 抽選ID |
| `--contract-address` | ✅ | - | デプロイされたコントラクトアドレス |
| `--address-column` | ❌ | `address` | CSVのアドレス列名 |
| `--batch-size` | ❌ | `1000` | バッチサイズ |
| `--delay` | ❌ | `2.0` | バッチ間の待機時間（秒） |
| `--dry-run` | ❌ | `False` | テスト実行モード |
| `--verbose` | ❌ | `False` | 詳細ログ表示 |

## CSVファイル形式

CSVファイルは以下の形式である必要があります：

```csv
address,name,email
0x1234567890abcdef1234567890abcdef12345678,Alice,alice@example.com
0x2345678901bcdef12345678901bcdef123456789,Bob,bob@example.com
```

- ヘッダー行が必要
- アドレス列のデフォルト名は `address`（`--address-column` で変更可能）
- その他の列は無視されます

## ガス最適化

- **バッチサイズ**: デフォルト1000件で設定済み
- **待機時間**: バッチ間に2秒の待機でネットワーク負荷を軽減
- **エラー処理**: 失敗したバッチは個別にログ出力

## エラー処理

スクリプトは以下のエラーを適切に処理します：

- 無効なアドレス形式
- CSVファイルの読み込みエラー
- Aptos CLIの実行エラー
- ネットワークタイムアウト

## ログ出力例

```
2024-06-12 12:00:00 - INFO - === Airdrop Lottery CSV Import 開始 ===
2024-06-12 12:00:00 - INFO - コントラクトアドレス: 0x123...
2024-06-12 12:00:00 - INFO - 抽選ID: 1
2024-06-12 12:00:01 - INFO - CSVファイルから 2500 件の有効なアドレスを読み込みました
2024-06-12 12:00:01 - INFO - 合計 2500 件のアドレスを 3 バッチに分割しました（バッチサイズ: 1000）

--- バッチ 1/3 処理中 ---
2024-06-12 12:00:02 - INFO - 実行中: 1000 件のアドレスを追加...
2024-06-12 12:00:05 - INFO - ✅ 成功: 1000 件のアドレスを追加しました
2024-06-12 12:00:05 - INFO - ⏳ 2.0秒待機中...

--- バッチ 2/3 処理中 ---
2024-06-12 12:00:07 - INFO - 実行中: 1000 件のアドレスを追加...
2024-06-12 12:00:10 - INFO - ✅ 成功: 1000 件のアドレスを追加しました
2024-06-12 12:00:10 - INFO - ⏳ 2.0秒待機中...

--- バッチ 3/3 処理中 ---
2024-06-12 12:00:12 - INFO - 実行中: 500 件のアドレスを追加...
2024-06-12 12:00:15 - INFO - ✅ 成功: 500 件のアドレスを追加しました

=== 処理結果サマリー ===
2024-06-12 12:00:15 - INFO - 成功バッチ数: 3/3
2024-06-12 12:00:15 - INFO - 失敗バッチ数: 0/3
2024-06-12 12:00:15 - INFO - 処理済みアドレス数: 2500/2500
2024-06-12 12:00:15 - INFO - 🎉 すべてのバッチが正常に処理されました！
```

## 注意事項

1. **事前準備**: Aptos CLIが正しく設定されていることを確認
2. **権限**: 抽選の作成者アカウントで実行する必要があります
3. **ガス費用**: 大量のアドレス処理には相応のガス費用が発生します
4. **重複チェック**: スマートコントラクト側で重複アドレスは自動的にスキップされます

## トラブルシューティング

### よくあるエラー

1. **E_NOT_AUTHORIZED (1)**: 抽選作成者以外のアカウントで実行している
2. **E_LOTTERY_NOT_FOUND (2)**: 指定した抽選IDが存在しない
3. **E_LOTTERY_ALREADY_COMPLETED (3)**: 既に完了した抽選に参加者を追加しようとしている

### 解決方法

- Aptos CLIの設定を確認: `aptos account list`
- 抽選の詳細を確認: `aptos move view --function-id <address>::airdrop_lottery::get_lottery_details --args u64:<lottery_id>`
- ネットワーク接続を確認
